name: lint

on:
  pull_request:
    branches:
      - master

jobs:
  lint:
    runs-on: [ubuntu-latest]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Setup luacheck
        run: |
          sudo apt update &&
          sudo apt install -y lua5.1 luarocks &&
          sudo luarocks install luacheck

      - name: Setup luacheck
        run: |
          sudo apt update
          sudo apt install -y lua5.1 luarocks
          sudo luarocks install luacheck

      - name: Setup selene
        run: |
          wget "https://github.com/Kampfkarren/selene/releases/download/$VERSION/selene-$VERSION-linux.zip"
          echo "$SHA256_CHECKSUM  selene-$VERSION-linux.zip" > "selene-$VERSION-linux.zip.checksum"
          sha256sum --check "selene-$VERSION-linux.zip.checksum"
          unzip "selene-$VERSION-linux.zip"
          install -Dp selene "$HOME/.local/bin/selene"

          echo "::add-matcher::.github/workflows/problem_matchers/selene.json"
        env:
          VERSION: "0.13.0"
          SHA256_CHECKSUM: "2c06fbcb793c8e18e54dc24470f32be0afd3c1d23ff23e8e22986ce4bf2db7d7"

      - name: Add $HOME/.local/bin to $PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run linters
        run: |
          make lint

  style-lint:
    runs-on: [ubuntu-latest]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Lint with stylua
        uses: JohnnyMorganz/stylua-action@1.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # CLI arguments
          args: --check .
